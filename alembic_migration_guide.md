# Guide pour Appliquer les Changements de Schéma avec Alembic

## Contexte
Pour appliquer les modifications apportées aux modèles (ajout du champ `mot_de_passe_temporaire` et création de la table `TentativeConnexion`), nous devons utiliser Alembic, l'outil de migration SQLAlchemy.

## Prérequis

1. **Alembic doit être installé** dans votre environnement virtuel:
   ```bash
   pip install alembic
   ```

2. **Alembic doit être configuré** pour votre projet. Si ce n'est pas déjà fait, suivez ces étapes:

## Configuration d'Alembic

### 1. Créer la structure d'Alembic
```bash
alembic init alembic
```

Cela crée un dossier `alembic` avec les fichiers de configuration.

### 2. Configurer `alembic.ini`
Modifiez le fichier `alembic.ini` pour pointer vers votre base de données:
```ini
sqlalchemy.url = mysql+pymysql://root:@localhost/genie_logiciel
```

### 3. Configurer `alembic/env.py`
Modifiez le fichier `alembic/env.py` pour importer vos modèles:

```python
# Dans la section import, ajoutez:
from models import Base
from models import Utilisateur, TentativeConnexion  # Ajoutez toutes vos tables

# Remplacez la fonction run_migrations_online par:
def run_migrations_online():
    connectable = engine_from_config(
        config.get_section(config.config_ini_section),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=Base.metadata,
            compare_type=True,  # Important pour détecter les changements de type
            compare_server_default=True,
        )
        with context.begin_transaction():
            context.run_migrations()
```

## Création d'une Migration

### 1. Générer une nouvelle migration
```bash
alembic revision -m "ajout_mot_de_passe_temporaire_et_tentatives_connexion"
```

Cela crée un nouveau fichier dans `alembic/versions/` avec un nom comme `xxxxxxxxx_ajout_mot_de_passe_temporaire_et_tentatives_connexion.py`.

### 2. Modifier le fichier de migration
Ouvrez le fichier généré et modifiez la fonction `upgrade()` et `downgrade()`:

```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('utilisateur', sa.Column('mot_de_passe_temporaire', sa.Boolean(), nullable=False, server_default='0'))
    
    op.create_table('tentative_connexion',
    sa.Column('id_tentative', sa.String(length=100), nullable=False),
    sa.Column('email', sa.String(length=191), nullable=False),
    sa.Column('date_tentative', sa.DateTime(), nullable=False, server_default=sa.text('CURRENT_TIMESTAMP')),
    sa.Column('succes', sa.Boolean(), nullable=False, server_default='0'),
    sa.PrimaryKeyConstraint('id_tentative')
    )
    
    # Mettre à jour les utilisateurs existants pour définir mot_de_passe_temporaire
    # Si un utilisateur a l'email "de@genielogiciel.com", marquer comme temporaire
    op.execute("""
        UPDATE utilisateur 
        SET mot_de_passe_temporaire = TRUE 
        WHERE email = 'de@genielogiciel.com'
    """)


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('utilisateur', 'mot_de_passe_temporaire')
    op.drop_table('tentative_connexion')
    
    # Remettre à FALSE si nécessaire (optionnel)
    op.execute("""
        UPDATE utilisateur 
        SET mot_de_passe_temporaire = FALSE 
        WHERE email = 'de@genielogiciel.com'
    """)
```

## Appliquer la Migration

### 1. Appliquer la migration à la base de données
```bash
alembic upgrade head
```

Cela applique toutes les migrations pendantes à votre base de données.

### 2. Vérifier que la migration a réussi
```bash
alembic current
```

Cela affiche la migration actuelle appliquée.

## Gestion des Migrations Futures

### Pour créer une nouvelle migration:
```bash
alembic revision -m "description_de_la_migration"
```

### Pour appliquer une migration spécifique:
```bash
alembic upgrade xxxxxxxx_description_de_la_migration.py
```

### Pour revenir en arrière:
```bash
alembic downgrade -1  # Revenir d'une migration
alembic downgrade base  # Revenir à la base
```

## Bonnes Pratiques

1. **Toujours tester les migrations** dans un environnement de développement avant de les appliquer en production
2. **Documenter chaque migration** avec un message clair et concis
3. **Faire des sauvegardes** avant d'appliquer des migrations importantes
4. **Vérifier les dépendances** entre les tables avant de supprimer ou modifier des colonnes
5. **Utiliser `compare_type=True`** dans la configuration pour détecter les changements de type de colonne

## Résolution des Problèmes Courants

### Problème: Alembic ne détecte pas les changements
**Solution**: 
- Vérifiez que vous avez importé toutes les tables dans `env.py`
- Utilisez `compare_type=True` dans la configuration
- Supprimez le dossier `alembic/versions/` et régénérez les migrations (si nécessaire)

### Problème: Erreur de dépendance entre tables
**Solution**:
- Appliquez les migrations dans l'ordre correct
- Utilisez `batch=True` pour les migrations complexes:
  ```python
  with op.batch_alter_table('utilisateur') as batch_op:
      batch_op.add_column(sa.Column('mot_de_passe_temporaire', sa.Boolean(), nullable=False, server_default='0'))
  ```

### Problème: Données existantes incompatibles
**Solution**:
- Utilisez `op.execute()` pour exécuter des requêtes SQL personnalisées
- Fournissez des valeurs par défaut appropriées avec `server_default`

## Exemple Complet de Migration

```python
"""
Ajout du champ mot_de_passe_temporaire et création de la table tentative_connexion
"""

from alembic import op
import sqlalchemy as sa


def upgrade():
    # Ajout de la colonne mot_de_passe_temporaire
    op.add_column('utilisateur', 
        sa.Column('mot_de_passe_temporaire', sa.Boolean(), 
                  nullable=False, server_default='0')
    )
    
    # Création de la table tentative_connexion
    op.create_table('tentative_connexion',
        sa.Column('id_tentative', sa.String(length=100), nullable=False),
        sa.Column('email', sa.String(length=191), nullable=False),
        sa.Column('date_tentative', sa.DateTime(), nullable=False, 
                  server_default=sa.text('CURRENT_TIMESTAMP')),
        sa.Column('succes', sa.Boolean(), nullable=False, 
                  server_default='0'),
        sa.PrimaryKeyConstraint('id_tentative')
    )
    
    # Mettre à jour le DE existant
    op.execute("""
        UPDATE utilisateur 
        SET mot_de_passe_temporaire = TRUE 
        WHERE email = 'de@genielogiciel.com'
    """)


def downgrade():
    # Suppression de la colonne
    op.drop_column('utilisateur', 'mot_de_passe_temporaire')
    
    # Suppression de la table
    op.drop_table('tentative_connexion')
    
    # Remettre à FALSE (optionnel)
    op.execute("""
        UPDATE utilisateur 
        SET mot_de_passe_temporaire = FALSE 
        WHERE email = 'de@genielogiciel.com'
    """)
```

## Commandes Utiles

| Commande | Description |
|----------|-------------|
| `alembic revision -m "message"` | Créer une nouvelle migration |
| `alembic upgrade head` | Appliquer toutes les migrations pendantes |
| `alembic downgrade -1` | Revenir d'une migration |
| `alembic current` | Voir la migration actuelle |
| `alembic history` | Voir l'historique des migrations |
| `alembic heads` | Voir les migrations disponibles |

## Intégration avec FastAPI

Pour intégrer Alembic avec votre application FastAPI, vous pouvez:

1. **Appliquer les migrations au démarrage** (dans `main.py`):
```python
from alembic.config import Config
from alembic import command

# Appliquer les migrations au démarrage
alembic_cfg = Config("alembic.ini")
command.upgrade(alembic_cfg, "head")
```

2. **Ou créer une route d'administration** (recommandé pour la production):
```python
@app.post("/admin/migrate")
def migrate_database():
    alembic_cfg = Config("alembic.ini")
    command.upgrade(alembic_cfg, "head")
    return {"message": "Migrations appliquées avec succès"}
```

**⚠️ Attention**: Ne pas appliquer automatiquement les migrations en production sans sauvegarde!
